#!/bin/bash
#定義主域名
pd[1]=ve8aiz1g.HHTRTR.COM
pd[2]=ohchai4j.IH279C.COM
pd[3]=cdn.h287xs.com
pd[4]=cdn1.189xqx.com
pd[5]=cdn2.f64xqc.com
pd[6]=p.fi729x.com
pd[7]=p.cth742.com
pd[8]=d1.10csqd.com
pd[9]=d2.10csqd.com
pd[10]=d4.10csqd.com
pd[11]=d5.10csqd.com
pd[12]=d1.09872mcz.com
pd[13]=d2.09872mcz.com
pd[14]=d61.h297bd.com
pd[15]=d62.hgtgwg.com
pd[16]=thes7ohw.HIOUYB.COM
pd[17]=ohy4ou6o.IO49UT.COM
pd[18]=cdn.huw83b.com
pd[19]=cdn.g59vwn.com
pd[20]=p.g7xb79.com
pd[21]=p.dhuw7B.com
pd[22]=d1.0xdwbd.com
pd[23]=d2.0xdwbd.com
pd[24]=d3.0xdwbd.com
pd[25]=d4.0xdwbd.com
pd[26]=d1.3oijsbg.com
pd[27]=d2.3oijsbg.com
pd[28]=d61.h29898.com
pd[29]=d62.heygge.com
pd[30]=iek7quoh.HIQIO9.COM
pd[31]=ehie5poo.IU489B.COM
pd[32]=cdn.hquyg1.com
pd[33]=cdn.gr3fw4.com
pd[34]=p.HWUUE3.COM
pd[35]=p.I371DS.COM
pd[36]=d1.028bqb.com
pd[37]=d3.028bqb.com
pd[38]=d1.6760jrk.com
pd[39]=d2.6760jrk.com
pd[40]=d61.h39xqg.com
pd[41]=d62.h8892k.com
pd[42]=ohdoo8ke.HIQO90.COM
pd[43]=ve5magah.IU87UI.COM
pd[44]=cdn.hfiwi8.com
pd[45]=cdn.gqca2e.com
pd[46]=p.G439CQ.COM
pd[47]=p.IIKUIH.COM
pd[48]=d1.018xqc.com
pd[49]=d3.018xqc.com
pd[50]=d1.79gsnze.com
pd[51]=d2.79gsnze.com
pd[52]=aiquuif6.HQ38CB.COM
pd[53]=beingah9.IUIYTT.COM
pd[54]=cdn.h4uy4b.com
pd[55]=cdn.gqyu83.com
pd[56]=p.FY28XQ.COM
pd[57]=p.G180QD.COM
pd[58]=d1.02uoew.com
pd[59]=d3.02uoew.com
pd[60]=d1.82yei58.com
pd[61]=d2.82yei58.com
pd[62]=oonoh9ya.HQGO02.COM
pd[63]=quai5ohg.OWXUK3.COM
pd[64]=cdn.gnetu3.com
pd[65]=cdn.gtyj67.com
pd[66]=p.G684BV.COM
pd[67]=p.I188BC.COM
pd[68]=d1.67emgf.com
pd[69]=d3.67emgf.com
pd[70]=d1.837srngk.com
pd[71]=d2.837srngk.com
pd[72]=aip6quoo.HQOUUC.COM
pd[73]=ethe5jae.OI38VO.COM
pd[74]=cdn.h1ycs2.com
pd[75]=cdn.0u8iu7.com
pd[76]=p.HWIX02.COM
pd[77]=p.J08FQK.COM
pd[78]=d1.78g6wt.com
pd[79]=d3.78g6wt.com
pd[80]=d1.83khuek.com
pd[81]=d2.83khuek.com
pd[82]=d61.h892yi.com
pd[83]=d62.heu239.com
pd[84]=sooh8laz.HT57JG.COM
pd[85]=eihiel2s.OEUX8L.COM
pd[86]=cdn.h29aiu.com
pd[87]=cdn.GRE684.COM
pd[88]=p.HWOUZ8.COM
pd[89]=p.I27GDQ.COM
pd[90]=d1.986j6u.com
pd[91]=d3.986j6u.com
pd[92]=d5.986j6u.com
pd[93]=d1.873yhke.com
pd[94]=d2.873yhke.com
pd[95]=d61.h2998f.com
pd[96]=d62.haoqbc.com
pd[97]=cohdi2di.HRTHRE.COM
pd[98]=kod4ohpo.NYUI5B.COM
pd[99]=cdn.hiqocu.com
pd[100]=cdn.GSA2T4.COM
pd[101]=p.HWUE1B.COM
pd[102]=p.I2X8QO.COM
pd[103]=d1.uf5467.com
pd[104]=d1.8929nhsi.com
pd[105]=d2.8929nhsi.com
pd[106]=roum4ui9.HREFAB.COM
pd[107]=oice0ha.NETHNM.COM
pd[108]=cdn.289XHI.COM
pd[109]=cdn.huqyo1.com
pd[110]=cdn.28BSCD.COM
pd[111]=p.hwuiwb.com
pd[112]=p.i028xq.com
pd[113]=d1.i78ui2.com
pd[114]=d1.97277aj.com
pd[115]=d2.97277aj.com
pd[116]=thohsee2.HR763N.COM
pd[117]=eji6uwoa.N2I8VJ.COM
pd[118]=cdn.h9cqiu.com
pd[119]=cdn.g2gr3f.com
pd[120]=p.HWUOZE.COM
pd[121]=p.I1083X.COM
pd[122]=d1.u38do3.com
pd[123]=d3.u38do3.com
pd[124]=d5.u38do3.com
pd[125]=d1.9762flt.com
pd[126]=d2.9762flt.com
pd[127]=d61.h297vw.com
pd[128]=d62.hi2qi8.com
pd[129]=riej4eid.HUWO8X.COM
pd[130]=cae8aice.MYDSRE.COM
pd[131]=cdn.h5yx91.com
pd[132]=cdn.H238XQ.COM
pd[133]=bne92aef2.phcuq2.com
pd[134]=ba984pp23.IUWX79.COM
pd[135]=d1.h29cuo.com
pd[136]=d3.h29cuo.com
pd[137]=d1.a7cu399.com
pd[138]=d2.a7cu399.com
pd[139]=luz6ooth.HTRJT7.COM
pd[140]=waht7aib.MUYJJW.COM
pd[141]=cdn.h983iu.com
pd[142]=cdn.289v7c.com
pd[143]=p.geg2w3.com
pd[144]=p.dhw1cd.com
pd[145]=d1.geriu8.com
pd[146]=d1.dw0d82.com
pd[147]=d1.ab398725.com
pd[148]=d2.ab398725.com
pd[149]=quicei1l.HTR2FS.COM
pd[150]=mephaa0o.MJK8TE.COM
pd[151]=cdn.h514g3.com
pd[152]=cdn.GXFER8.COM
pd[153]=p.435X4H.COM
pd[154]=p.GY03XC.COM
pd[155]=d1.GY19GQ.COM
pd[156]=d1.HWO03C.COM
pd[157]=d3.GY19GQ.COM
pd[158]=d1.ahbrp2u6.com
pd[159]=d2.ahbrp2u6.com
pd[160]=d61.h299vf.com
pd[161]=d62.h92dab.com
pd[162]=aiy6uthe.HSWBJU.COM
pd[163]=to6aidie.LP87Nh.com
pd[164]=cdn.huweho.com
pd[165]=cdn.H19VE4.COM
pd[166]=p.44578R.COM
pd[167]=p.H1Y9CS.COM
pd[168]=d1.H1YC8C.COM
pd[169]=d1.HWO38B.COM
pd[170]=d3.H1YC8C.COM
pd[171]=d1.aku385my.com
pd[172]=d2.aku385my.com
pd[173]=ziemooj4.HUQ28V.COM
pd[174]=gaiquiy1.KUYHH5.COM
pd[175]=cdn.hiue89.com
pd[176]=cdn.H278QB.COM
pd[177]=p.4578VW.COM
pd[178]=p.H278XQ.COM
pd[179]=d1.H27C9D.COM
pd[180]=d2.H27C9D.COM
pd[181]=d1.bank5265.com
pd[182]=d2.bank5265.com
pd[183]=iedi5uti.HU289D.COM
pd[184]=taechee9.JYUOJ9.COM
pd[185]=cdn.h9kqiu.com
pd[186]=cdn.JYYWFS.COM
pd[187]=p.hyilil.com
pd[188]=p.j548sw.com
pd[189]=d1.hyq938.com
pd[190]=d1.j558cg.com
pd[191]=d1.hbsucjm.com
pd[192]=d2.hbsucjm.com
pd[193]=eec6jes6.HTTY6T.COM
pd[194]=ierie2pi.JYTEAF.COM
pd[195]=cdn.h8dy78.com
pd[196]=cdn.mhfyi7.com
pd[197]=p.hywbc1.com
pd[198]=p.j654sg.com
pd[199]=d1.hywfwv.com
pd[200]=d1.j6gr8j.com 
pd[201]=d1.hcjxoife.com
pd[202]=d2.hcjxoife.com
pd[203]=d61.h29c7d.com
pd[204]=d62.h5t6dg.com
pd[205]=yokeel5e.HQXGU2.COM
pd[206]=ie5jeek9.JYTE6B.COM
pd[207]=cdn.huiw2x.com
pd[208]=cdn.n563gd.com
pd[209]=p.i388eu.com
pd[210]=p.j94tw3.com
pd[211]=d1.i6hu5j.com
pd[212]=d2.i6hu5j.com
pd[213]=d1.ismt9277.com
pd[214]=d2.ismt9277.com
pd[215]=ahw0shec.HQUC21.COM
pd[216]=ahmuyi8w.JTHST6.COM
pd[217]=cdn.hqouc8.com
pd[218]=cdn.o729xq.com
pd[219]=wga4eqy4.nfsg3r.com
pd[220]=234yq35y.lx97bc.com
pd[221]=d1.klou86.com
pd[222]=d2.klou86.com
pd[223]=d1.iwghers.com
pd[224]=d2.iwghers.com
pd[225]=d61.heiu92.com
pd[226]=d62.hioy2f.com
pd[227]=gi4chie1.HIU89D.COM
pd[228]=iesohko4.NY3GWF.COM
pd[229]=cdn.herer5.com
pd[230]=cdn.nq8cqf.com
pd[231]=p.K663GE.COM
pd[232]=p.MBWVWS.COM
pd[233]=d1.JOQU17.COM
pd[234]=d2.JOQU17.COM
pd[235]=d1.jekdiro.com
pd[236]=d2.jekdiro.com
pd[237]=shu4laec.HIQO28.COM
pd[238]=kolie0vu.O8923I.COM
pd[239]=cdn.h72xqx.com
pd[240]=cdn.kuo8p9.com
pd[241]=p.OK8LI6.COM
pd[242]=p.JYJYTU.COM
pd[243]=d1.netwbm.com
pd[244]=d2.netwbm.com
pd[245]=d1.jgg1748.com
pd[246]=d2.jgg1748.com
pd[247]=d61.h983nv.com
pd[248]=d62.hgwrfd.com
pd[249]=bhw3.wnzdyleo8.com 
pd[250]=cdn.eyftgcmu5.com
pd[251]=p.utegulbr7.com
pd[252]=d1.ejdfp9264.com
pd[253]=bxgz4.djhpwj734.com
pd[254]=cdn.mczxang94.com
pd[255]=p.odslyck50.com
pd[256]=d1.twhdwfwc6.com
pd[257]=bzc.kzdvisvt8.com
pd[258]=cdn.sbicqcm71.com
pd[259]=p.utrtw7848.com
pd[260]=d1.lnmjpusy0.com
pd[261]=bzs7.zbtrgdog2.com
pd[262]=cdn.bmfjhd935.com
pd[263]=p.iyyualqh3.com
pd[264]=d1.mktgmi356.com

function helps {
    echo "說明："
    echo "使用語法：sh domain_add.sh 指令 域名，共有2個參數要輸入"
    echo "參數一，指令，有下列三種可選用： add (新增)  del (刪除)  show (查詢)"
    echo "參數二，域名：就是要綁定或解除的域名"
    echo "如果在使用指令show時，可查詢所有域名"
}
function reloadnginx {
    #如果有動到conf檔就重啟
    if [ $? = 0 ] ;then
        #測試設定檔是否正確
        /opt/APP/openresty/nginx/sbin/nginx -t
        #重載nginx設定檔
        if [ $? = 0 ]; then
            echo "測試nginx設定檔成功，開始重載nginx設定檔"
            service nginx reload
            if [ $? = 0 ]; then
                echo "重新載入nginx設定檔成功"
            else
                echo "重載nginx設定檔失敗，請到RP上使用nginx -t查詢做確認"
                exit
            fi
        else
            echo "測試nginx設定檔失敗，請查看/opt/APP/openresty/nginx/conf/nginx.conf確認那邊出錯"
            exit
        fi
    fi
}
#確認是否有加密
netstat -plnt | grep 'nginx' | grep '443'
if [ $? = 0 ] ;then
    echo "有SSL"
    #列出所有vhost的conf檔
    nginxconf=/opt/APP/openresty/nginx/conf/vhost/*.conf
else
    echo "沒SSL"
    #列出所有vhost的conf檔
    nginxconf=/opt/APP/openresty/nginx/conf/vhost/*.conf
fi
#判斷是新增還是刪除
case "$1" in
"add")
    #判斷輸入參數個數
    if [ $# -ne "2" ];then
        echo "參數錯誤："
        helps
        exit
    fi
    #列出所有conf檔
    for filepathe in $nginxconf
    do
        echo "檢查是否有綁定過此域名"
        grep '^[ \s\t]*server_name[ \s\t]*[0-9A-Za-z]*\.[0-9A-Za-z]*' $filepathe | grep ' '$2'[ ;]' > /dev/null
        if [ $? = 0 ] ;then
            echo "$2此域名已綁定過了"
            continue
        else
            echo "開始新增$2到$filepathe"
            sed -i '/^[ \s\t]*server_name[ \s\t]*[0-9A-Za-z]*\.[0-9A-Za-z]*/s/;/ '$2';/' $filepathe
            if [ $? = 0 ] ;then
                echo "新增域名$2成功"
                reloadnginx
            else
                echo "新增域名$2失敗"
                exit
            fi
        fi
    done
    ;;
"del")
    #判斷輸入參數個數
    if [ $# -ne "2" ];then
        echo "參數錯誤："
        helps
        exit
    fi
    #判斷輸入的是否為主域名，主域名強制不可刪除
    for item in "${pd[@]}"; do
        if [[ $2 == "$item" ]]; then
            echo "主域名強制不可刪除"
            exit
        fi
    done
    #列出所有conf檔
    for filepathe in $nginxconf
    do
        echo "檢查是否有綁定過此域名"
        grep '^[ \s\t]*server_name[ \s\t]*[0-9A-Za-z]*\.[0-9A-Za-z]*' $filepathe | grep ' '$2'[ ;]' > /dev/null
        if [ $? = 0 ] ;then
            echo "開始把$2從$filepathe刪除"
            sed -i '/^[ \s\t]*server_name[ \s\t]*[0-9A-Za-z]*\.[0-9A-Za-z]*/s/ '$2'//' $filepathe
            if [ $? = 0 ] ;then
                echo "刪除域名$2成功"
                reloadnginx
            else
                sed -i '/^[ \s\t]*server_name[ \s\t]*[0-9A-Za-z]*\.[0-9A-Za-z]*/s/ '$2';//' $filepathe
                if [ $? = 0 ] ;then
                    echo "刪除域名$2成功"
                    reloadnginx
                else
                    echo "刪除域名$2失敗"
                    exit
                fi
            fi
        else
            echo "在$filepathe裡找不到$2這個域名"
            continue
        fi
    done
    ;;
"show")
    #抓取vhost config內綁定域名並解析出IP，把每個域名與IP中間用空白隔開，並每筆輸出成一行
    regex='^\w+\.+\w'
        if [[ -z "$2" ]] ;then
            domains=`grep '^[ \s\t]*server_name[ \s\t]*[0-9A-Za-z]*\.[0-9A-Za-z]*' $nginxconf | sed -r 's/(.*server_name\s*|;)//g' | uniq`
        else
            grep '^[ \s\t]*server_name[ \s\t]*[0-9A-Za-z]*\.[0-9A-Za-z]*' $nginxconf | grep ' '$2'[ ;]'
            if [ $? = 0 ] ;then
                domains=$2
            fi
        fi
    for domain in $domains; do
        if [[ $domain =~ $regex ]]; then
            echo -n $domain;
            ip=$(nslookup "$domain" | awk '/^Address: / { print $2 }')
            echo -n ' ';
            echo $ip;
        else
            echo $domain " is not match";
        fi
    done
    ;;
*)
    echo "指令只有add、del、show這三種可以用"
    helps
    #if [[ $fe =~ *SSL* ]];then
        #echo " "
    #else
        #echo " "
    #fi
    exit
    ;;
esac
